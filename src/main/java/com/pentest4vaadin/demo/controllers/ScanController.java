
package com.pentest4vaadin.demo.controllers;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import com.pentest4vaadin.demo.entities.UrlMapping;
import com.pentest4vaadin.demo.repositories.UrlMappingRepository;
import com.pentest4vaadin.demo.services.SeleniumRequestHandler;

import java.util.Map;

/**
 * Controller for handling the requests that are sent by an external (scanner)
 * tool. Requests are "translated" into JavaScript actions that are executed
 * with Selenium.
 */
@RestController
@RequestMapping(value = "/scan")
public class ScanController {
	private static final Logger LOG = LoggerFactory.getLogger(ScanController.class);

	@Autowired
	private UrlMappingRepository urlMappingRepository;
	@Autowired
	private SeleniumRequestHandler seleniumRequestHandler;

    /**
     * Executes actions that are associated with the given form.
     *
     * @param parameters JSON String that contains the parameters which are inserted in the input fields.
     * @param formname   The name of the form that is scanned
     * @return ResponseEntity<String> HTTP OK if requests could be processed, HTTP NOT FOUND otherwise
     */
    @RequestMapping(value = "/{formname}*", method = RequestMethod.GET)
    public ResponseEntity<String> processRequest(@RequestParam Map<String, String> parameters, @PathVariable("formname") String formname) {
        UrlMapping urlParams = urlMappingRepository.findByName(formname);

        if (urlParams == null) {
            LOG.debug("Request to invalid form '" + formname + "' was received. Sending HTTP NOT FOUND response.");
            return new ResponseEntity<>("Form was not found.", HttpStatus.NOT_FOUND);
        }

		LOG.debug("Handle request regarding form '" + formname + "'.");

        // Send real requests to application.
        String pagecode = seleniumRequestHandler.sendRequests(urlParams, parameters);

        return new ResponseEntity<>(pagecode, seleniumRequestHandler.getStatusCode());
    }
}
