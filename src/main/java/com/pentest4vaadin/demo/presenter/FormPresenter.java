
package com.pentest4vaadin.demo.presenter;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import com.pentest4vaadin.demo.entities.NativeHtmlMapping;
import com.pentest4vaadin.demo.entities.UrlMapping;
import com.pentest4vaadin.demo.entities.VaElement;
import com.pentest4vaadin.demo.repositories.NativeHtmlMappingRepository;
import com.pentest4vaadin.demo.repositories.UrlMappingRepository;
import com.pentest4vaadin.demo.repositories.VaElementRepository;
import com.pentest4vaadin.demo.services.SeleniumBrowser;

import java.io.ByteArrayInputStream;
import java.util.List;

@Component
public class FormPresenter {
    private static final Logger LOG = LoggerFactory.getLogger(FormPresenter.class);

    @Autowired
    private SeleniumBrowser browser;
    @Autowired
    private VaElementRepository vaElementRepository;
    @Autowired
    private UrlMappingRepository urlMappingRepository;
    @Autowired
    private NativeHtmlMappingRepository nativeHtmlMappingRepository;

    @Value("${server.port}")
    private String serverPort;

    @Value("${server.address}")
    private String serverAddress;

    public void startBrowserBtnClicked(String url) {
        browser.startBrowser(url);
    }

    public List<VaElement> getAllMappings(UrlMapping mapping) {
        return vaElementRepository.findAllByUrlMappingOrderByOrderpos(mapping);
    }

    public void deleteFormMapping(UrlMapping value) {
        LOG.debug("Deleting the form '" + value.getName() + "' and all associated elements.");
        vaElementRepository.deleteVaElementsByUrlMapping(value);
        urlMappingRepository.delete(value);
    }

    public List<UrlMapping> getAllUrlMappings() {
        return urlMappingRepository.findAll();
    }

    public List<NativeHtmlMapping> getAllNativeHtmlMappings() {
        return nativeHtmlMappingRepository.findAll();
    }

    public void saveElement(VaElement item) {
        LOG.debug("Update element with HTML Tag '" + item.getNativeHtmlMapping().getHtmltag() + "' of form '" + item.getUrlMapping().getName() + "'.");
        vaElementRepository.save(item);
    }

    /**
     * Exports all urls to a text file.
     * @return StreamResource of file
     */
    public ByteArrayInputStream exportURLs() {
        // Create string of all urls.
        StringBuilder filecontents = new StringBuilder();
        List<VaElement> elements;
        VaElement el;

        for (UrlMapping mapping : urlMappingRepository.findAll()) {
            filecontents.append("http://" + serverAddress + ":" + serverPort + "/scan/" + mapping.getName());

            elements = vaElementRepository.findAllByUrlMappingOrderByOrderpos(mapping);
            if(elements.size() > 0) {
                filecontents.append("?");
            }

            for (int i = 0; i < elements.size(); i++) {
                el = elements.get(i);
                // Export only parameters that are injectable.
                if (el.getDefaultValue() == null || el.getDefaultValue().isEmpty()) {
                    filecontents.append(el.getParameter() + "=" + "val" + "&");
                }
            }
            if(filecontents.charAt(filecontents.length()-1) == '&') {
                filecontents.deleteCharAt(filecontents.length()-1);
            }

            filecontents.append("\n");
        }

        // Return byte stream of string.
       return new ByteArrayInputStream(filecontents.toString().getBytes());
    }
}
