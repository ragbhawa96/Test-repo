
package com.pentest4vaadin.demo.views;

import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.combobox.ComboBox;
import com.vaadin.flow.component.grid.Grid;
import com.vaadin.flow.component.grid.Grid.Column;
import com.vaadin.flow.component.grid.editor.Editor;
import com.vaadin.flow.component.html.Anchor;
import com.vaadin.flow.component.html.Div;
import com.vaadin.flow.component.icon.Icon;
import com.vaadin.flow.component.icon.VaadinIcon;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.data.binder.Binder;
import com.vaadin.flow.data.converter.StringToIntegerConverter;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.server.StreamResource;
import org.springframework.beans.factory.annotation.Autowired;
import com.pentest4vaadin.demo.entities.NativeHtmlMapping;
import com.pentest4vaadin.demo.entities.UrlMapping;
import com.pentest4vaadin.demo.entities.VaElement;
import com.pentest4vaadin.demo.presenter.FormPresenter;

/**
 * View that shows the forms and the associated elements. Editing functionality for the elements is also provided.
 */
@Route(value = "forms", layout = MainView.class)
public class FormView extends VerticalLayout {
    private Grid<VaElement> grid = new Grid<>();

    public FormView(@Autowired FormPresenter presenter) {
        // Actions for browser.
        TextField tfUrl = new TextField("URL");

        Button btnStartFrom = new Button("Start Form Selector", e -> {
            presenter.startBrowserBtnClicked(tfUrl.getValue());
        });

        HorizontalLayout layoutSelector = new HorizontalLayout();
        layoutSelector.add(tfUrl, btnStartFrom);

        // Load forms.
        ComboBox<UrlMapping> cbForms = new ComboBox<>("Forms");
        cbForms.setItemLabelGenerator(UrlMapping::getName);
        cbForms.setItems(presenter.getAllUrlMappings());
        cbForms.addValueChangeListener(e -> {
            grid.setItems(presenter.getAllMappings(cbForms.getValue()));
        });

        // Add action bar.
        Button btnDeleteForm = new Button(new Icon(VaadinIcon.TRASH), e-> {
            presenter.deleteFormMapping(cbForms.getValue());
            cbForms.setItems(presenter.getAllUrlMappings());
            grid.setItems();
        });

        Button btnExportUrls = new Button("Export URLs");
        Anchor downloadUrls = new Anchor(new StreamResource("urls.txt", () -> presenter.exportURLs()), "");
        downloadUrls.getElement().setAttribute("download", true);
        downloadUrls.add(btnExportUrls);

        HorizontalLayout actionbar = new HorizontalLayout();
        actionbar.add(cbForms, btnDeleteForm, downloadUrls);

        // Load form details.
        grid.addColumn(VaElement::getId).setHeader("ID");
        Column<VaElement> htmltagColumn = grid.addColumn(element -> element.getNativeHtmlMapping().getHtmltag()).setHeader("HTML Tag");
        grid.addColumn(VaElement::getPosition).setHeader("Position");
        Column<VaElement> orderposColumn = grid.addColumn(VaElement::getOrderpos).setHeader("Order");
        Column<VaElement> parameterColumn = grid.addColumn(VaElement::getParameter).setHeader("Paramenter");
        Column<VaElement> defaultvalColumn = grid.addColumn(VaElement::getDefaultValue).setHeader("Default value");

        // Create input elements for editing mode.
        ComboBox<NativeHtmlMapping> cbNativeHtml = new ComboBox<>();
        cbNativeHtml.setItemLabelGenerator(NativeHtmlMapping::getHtmltag);
        cbNativeHtml.setItems(presenter.getAllNativeHtmlMappings());

        TextField tfOrderpos = new TextField();
        TextField tfParameter = new TextField();
        TextField tfDefaultVal = new TextField();

        // Add editor.
        Binder<VaElement> binder = new Binder<>(VaElement.class);
        Editor<VaElement> editor = grid.getEditor();
        editor.setBinder(binder);
        editor.setBuffered(true);

        binder.bind(cbNativeHtml, "nativeHtmlMapping");
        htmltagColumn.setEditorComponent(cbNativeHtml);
        binder.forField(tfOrderpos).withConverter(new StringToIntegerConverter("Please insert number!")).bind("orderpos");
        orderposColumn.setEditorComponent(tfOrderpos);
        binder.bind(tfParameter, "parameter");
        parameterColumn.setEditorComponent(tfParameter);
        binder.bind(tfDefaultVal, "defaultValue");
        defaultvalColumn.setEditorComponent(tfDefaultVal);

        Button btnSave = new Button("Save", e -> editor.save());
        Button btnCancel = new Button("Cancel", e -> editor.cancel());
        Div buttons = new Div(btnSave, btnCancel);

        Column<VaElement> editorColumn = grid.addComponentColumn(element -> {
           Button btnEdit = new Button(new Icon(VaadinIcon.EDIT));
            btnEdit.addClickListener( e -> editor.editItem(element));
            return btnEdit;
        });
        editorColumn.setEditorComponent(buttons);

        editor.addSaveListener(event -> {
            presenter.saveElement(event.getItem());
        });

        this.add(layoutSelector, actionbar, grid);
    }
}
